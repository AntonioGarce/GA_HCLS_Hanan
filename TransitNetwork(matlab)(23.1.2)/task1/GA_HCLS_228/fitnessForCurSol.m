clear
close all 
clc
%%
totalroutes = 22;
minroutelen = 10;
maxroutelen = 35;
%% read excel file
[num1,txt1,~] = xlsread('KRAKOW - FULL DATA.xlsx','TRAFFIC-DEMAND');
[num2,txt2,~] = xlsread('KRAKOW - FULL DATA.xlsx','GRAPH');

srcnodes = num2(:,1);
dstnodes = num2(:,2);
demands = num1(:,3);
%% get nodes and make matrix
nodes = unique([srcnodes;dstnodes]);
nodenames = cell(1,length(nodes));
numnodes = length(nodes);
demandMatrix = zeros(numnodes,numnodes);

%% set elements of demand matrix.
srcnodes = num1(:,1);
dstnodes = num1(:,2);
for i=1:length(srcnodes)
    indsrc = find(nodes==srcnodes(i));
    inddst = find(nodes==dstnodes(i));
    if(~isempty(indsrc) && ~isempty(inddst))
        demandMatrix(indsrc,inddst) = demandMatrix(indsrc,inddst)+demands(i);
        demandMatrix(inddst,indsrc) = demandMatrix(indsrc,inddst);
    end
end
%% set elements of timetravel matrix
travelTimeMatrix = zeros(numnodes,numnodes);

srcnodes = num2(:,1);
dstnodes = num2(:,2);
time = num2(:,3);

for i=1:length(srcnodes)
    indsrc = find(nodes==srcnodes(i));
    inddst = find(nodes==dstnodes(i));
    travelTimeMatrix(indsrc,inddst) = time(i);
    travelTimeMatrix(inddst,indsrc) = time(i);
    nodenames{indsrc} = txt2(i+1,4);
    nodenames{inddst} = txt2(i+1,5);
end

for i = 1:numnodes
    for j = i+1:numnodes
        if(travelTimeMatrix(i,j) == 0)
            travelTimeMatrix(i,j) = Inf;
            travelTimeMatrix(j,i) = Inf;
        end
    end
end

%% 
currSolution={[125,	124,	123,	122,	121,	120,	119,	118,	117,...
    103,	116,	115,	885,	112,	452,	814,	813,	812,...
    811,	810,	809,	808,	807,	806,	821,	822,	823,...
    300,	301], [301,	300,	823,	822,	827,	833,	801,	851,...
    852,	853,	854], [702,	657,	656,	655,	649,	648,	647,...
    646,	645,	644,	643,	642,	640,	816,	815,	807,...
    806,	801,	760,	839,	381,	382,	383,	416],[125,	124,...
    123,	122,	194,	193,	107,	106,	105,	104,	103,...
    102,	101,	100,	805,	804,	803,	802,	851,	801,...
    833,	827,	828,	829,	354,	355,	356,	169,	357,...
    358,	359,	360],[125,	124,	123,	122,	121,	120,	119,...
    118,	117,	103,	102,	101,	100,	805,	804,	803,	802,...
    901,	839,	381,	382,	383,	416],[584,	583,	627,	634,...
    635,	646,	645,	644,	643,	642,	641,	556,	820,...
    819,	818,	817,	821,	822,	824,	825,	345,	453,	346,	347],...
    [562,	743,	561,	553,	559,	558,	557,	556,	820,	819,	...
    818,	817,	821,	822,	827,	828,	829,	354,	355,	356,	169,...
    357,	358,	359,	360],[139,	140,	141,	143,	161,	162,	135,	...
    118,	117,	103,	102,	101,	100,	805,	804,	803,	802,	...
    809,	619,	294,	670,	671,	674,	501,	645,	646,	647,	648,...
    649,	655,	656,	657,	702],[218,	217,	216,	215,	214,	213,	889,...
    212,	107,	106,	105,	104,	103,	102,	101,	100,	805,	804,	...
    803,	802,	851,	801,	806,	817,	818,	819,	820,	556,	557,...
    558,	559,	553],[711,	678,	674,	501,	644,	643,	642,	641,	556,...
    557,	558,	559,	553,	552,	551,	528,	526,	527,	706,	291,	...
    292,	293],[702,	657,	656,	655,	649,	648,	647,	646,	645,	644,...
    643,	642,	641,	556,	820,	819,	818,	817,	821,	822,	827,	...
    828,	829,	354,	355,	356,	169,	357],[139,	140,	141,	143,	161,...
    162,	135,	118,	117,	103,	116,	115,	885,	112,	452,	814,	...
    813,	812,	811,	810,	809,	802,	851,	801,	833,	827,	828,	...
    829,	354,	355,	356,	169,	357],[293,	292,	291,	706,	527,	526,...
    528,	551,	552,	553,	559,	558,	557,	556,	640,	816,	815,	...
    807,	808,	809,	802,	901,	839,	381],[293,	292,	291,	706,	527,...
    526,	528,	525,	524,	523,	522,	501,	872,	819,	818,	817,	...
    821,	822,	827,	833,	834,	835,	381,	382,	383,	416],[562,	743,...
    561,	553,	559,	558,	557,	556,	640,	816,	815,	807,	808,	...
    809,	802,	901,	839,	381],[711,	678,	674,	671,	670,	294,	619,...
    809,	802,	851,	801,	833,	827,	824,	825,	345,	453,	346,	...
    347],[218,	217,	216,	215,	214,	213,	889,	212,	107,	106,	105,...
    136,	118,	135,	162,	161,	144,	147,	148],[562,	743,	561,	553,...
    552,	551,	525,	524,	523,	522,	501,	872,	819,	807,	808,	...
    809,	810,	811,	812,	813,	814,	452,	112,	885,	115,	116,	...
    103,	104,	105,	106,	107,	212],[584,	583,	627,	634,	635,	646,...
    645,	644,	643,	642,	640,	816,	815,	807,	806,	801,	833,	...
    827,	828,	829,	354,	355,	356,	169,	357,	358,	359,	360],   ...
    [702,	657,	656,	655,	649,	648,	647,	646,	645,	501,	674,	...
    671,	670,	294,	619,	809,	802,	803,	804,	805],[416,	383,	382,...
    381,	839,	901,	802,	809,	619,	294,	670,	671,	674,	501,	...
    645,	646,	635,	634,	627,	583,	584],[293,	292,	291,	706,	527,...
    526,	528,	525,	524,	523,	522,	501,	872,	819,	807,	806,	...
    801,	851,	802,	803,	804,	805,	100,	101,	102,	103,	117,	...
    118,	135,	162,	161,	144,	147,	148]};

currSol_ind = {};

for rou_i = 1:length(currSolution)
    route = currSolution{rou_i};
    roulen = length(route);
    rou_ind = zeros(1,roulen);
    for node_i = 1:roulen
        rou_ii = find(nodes==route(node_i));
        rou_ind(node_i) = rou_ii(1);
    end
    currSol_ind{rou_i} = rou_ind;
end

ffval = ff_fun(currSol_ind,demandMatrix,travelTimeMatrix,0.4,0.5,0.1,0.6,0.3,0.1,5,10);

disp("TF: "+num2str(ffval.TF));
disp("ATT: "+num2str(ffval.ATT));
disp("PT0: "+num2str(ffval.PT0));
disp("PT1: "+num2str(ffval.PT1));
disp("PT2: "+num2str(ffval.PT2));
disp("PUD: "+num2str(ffval.PUD));
